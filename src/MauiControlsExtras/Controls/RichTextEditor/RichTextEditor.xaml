<?xml version="1.0" encoding="utf-8" ?>
<base:TextStyledControlBase xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                            xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                            xmlns:base="clr-namespace:MauiControlsExtras.Base"
                            xmlns:local="clr-namespace:MauiControlsExtras.Controls"
                            x:Class="MauiControlsExtras.Controls.RichTextEditor"
                            x:Name="thisControl">

    <Border StrokeThickness="{Binding EffectiveBorderThickness, Source={x:Reference thisControl}}"
            Stroke="{Binding EffectiveBorderColor, Source={x:Reference thisControl}}"
            BackgroundColor="{Binding EffectiveEditorBackground, Source={x:Reference thisControl}}">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="{Binding EffectiveCornerRadius, Source={x:Reference thisControl}}" />
        </Border.StrokeShape>

        <Grid RowDefinitions="Auto,*,Auto">
            <!-- Top Toolbar -->
            <ScrollView x:Name="topToolbar"
                        Grid.Row="0"
                        Orientation="Horizontal"
                        HorizontalScrollBarVisibility="Never"
                        IsVisible="{Binding ShowTopToolbar, Source={x:Reference thisControl}}"
                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">
                <HorizontalStackLayout Padding="4" Spacing="2">
                    <!-- Bold -->
                    <Button x:Name="boldButton"
                            Text="B"
                            FontAttributes="Bold"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Bold, Source={x:Reference thisControl}}"
                            Clicked="OnBoldClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Italic -->
                    <Button x:Name="italicButton"
                            Text="I"
                            FontAttributes="Italic"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Italic, Source={x:Reference thisControl}}"
                            Clicked="OnItalicClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Underline -->
                    <Button x:Name="underlineButton"
                            Text="U"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Underline, Source={x:Reference thisControl}}"
                            Clicked="OnUnderlineClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Strikethrough -->
                    <Button x:Name="strikethroughButton"
                            Text="S"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Strikethrough, Source={x:Reference thisControl}}"
                            Clicked="OnStrikethroughClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Separator -->
                    <BoxView WidthRequest="1"
                             HeightRequest="24"
                             VerticalOptions="Center"
                             Color="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                             IsVisible="{Binding ToolbarItems.BulletList, Source={x:Reference thisControl}}" />

                    <!-- Bullet List -->
                    <Button x:Name="bulletListButton"
                            Text="â€¢"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.BulletList, Source={x:Reference thisControl}}"
                            Clicked="OnBulletListClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Numbered List -->
                    <Button x:Name="numberedListButton"
                            Text="#"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.NumberedList, Source={x:Reference thisControl}}"
                            Clicked="OnNumberedListClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Separator -->
                    <BoxView WidthRequest="1"
                             HeightRequest="24"
                             VerticalOptions="Center"
                             Color="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                             IsVisible="{Binding ToolbarItems.Heading, Source={x:Reference thisControl}}" />

                    <!-- Headings -->
                    <Button x:Name="h1Button"
                            Text="H1"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Heading, Source={x:Reference thisControl}}"
                            Clicked="OnH1Clicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <Button x:Name="h2Button"
                            Text="H2"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Heading, Source={x:Reference thisControl}}"
                            Clicked="OnH2Clicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Quote -->
                    <Button x:Name="quoteButton"
                            Text='"'
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Quote, Source={x:Reference thisControl}}"
                            Clicked="OnQuoteClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Code -->
                    <Button x:Name="codeButton"
                            Text="&lt;/&gt;"
                            WidthRequest="44"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.CodeBlock, Source={x:Reference thisControl}}"
                            Clicked="OnCodeBlockClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Separator -->
                    <BoxView WidthRequest="1"
                             HeightRequest="24"
                             VerticalOptions="Center"
                             Color="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                             IsVisible="{Binding ToolbarItems.Link, Source={x:Reference thisControl}}" />

                    <!-- Link -->
                    <Button x:Name="linkButton"
                            Text="ðŸ”—"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Link, Source={x:Reference thisControl}}"
                            Clicked="OnLinkClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Image -->
                    <Button x:Name="imageButton"
                            Text="ðŸ–¼"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Image, Source={x:Reference thisControl}}"
                            Clicked="OnImageClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Separator -->
                    <BoxView WidthRequest="1"
                             HeightRequest="24"
                             VerticalOptions="Center"
                             Color="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                             IsVisible="{Binding ToolbarItems.Undo, Source={x:Reference thisControl}}" />

                    <!-- Undo -->
                    <Button x:Name="undoButton"
                            Text="â†©"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Undo, Source={x:Reference thisControl}}"
                            Clicked="OnUndoClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Redo -->
                    <Button x:Name="redoButton"
                            Text="â†ª"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.Redo, Source={x:Reference thisControl}}"
                            Clicked="OnRedoClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />

                    <!-- Clear Formatting -->
                    <Button x:Name="clearFormatButton"
                            Text="Tx"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            IsVisible="{Binding ToolbarItems.ClearFormatting, Source={x:Reference thisControl}}"
                            Clicked="OnClearFormattingClicked"
                            BackgroundColor="Transparent"
                            TextColor="{Binding EffectiveForegroundColor, Source={x:Reference thisControl}}" />
                </HorizontalStackLayout>
            </ScrollView>

            <!-- WebView Editor -->
            <WebView x:Name="editorWebView"
                     Grid.Row="1"
                     MinimumHeightRequest="{Binding MinHeight, Source={x:Reference thisControl}}"
                     Navigating="OnWebViewNavigating" />

            <!-- Bottom Toolbar -->
            <ScrollView x:Name="bottomToolbar"
                        Grid.Row="2"
                        Orientation="Horizontal"
                        HorizontalScrollBarVisibility="Never"
                        IsVisible="{Binding ShowBottomToolbar, Source={x:Reference thisControl}}"
                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}">
                <!-- Bottom toolbar content would be same as top, omitted for brevity -->
            </ScrollView>

            <!-- Loading Indicator -->
            <ActivityIndicator x:Name="loadingIndicator"
                               Grid.Row="1"
                               IsRunning="{Binding IsLoading, Source={x:Reference thisControl}}"
                               IsVisible="{Binding IsLoading, Source={x:Reference thisControl}}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Color="{Binding EffectiveAccentColor, Source={x:Reference thisControl}}" />
        </Grid>
    </Border>
</base:TextStyledControlBase>
